<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">

<!-- Mirrored from www.classicshell.net/forum/viewtopic.php?f=12&t=7921&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 08 Jun 2018 09:12:15 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<meta name="robots" content="noindex" />
<title>Classic Shell :: View topic - User photo not loaded</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">Classic Shell</span><br /><span class="gensmall"><a href="index.html">http://www.classicshell.net/forum/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">User photo not loaded</span><br /><span class="gensmall"><a href="viewtopic2e6b.html?f=12&amp;t=7921">http://www.classicshell.net/forum/viewtopic.php?f=12&amp;t=7921</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>1</strong> of <strong>1</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>skonvols2k</b> [ Wed Sep 20, 2017 1:01 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>User photo not loaded</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Hi,<br />as many users do i have my company's users photos loaded in active directory, Windows 10 users' photos are loaded by the powershell logon below:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&#91;CmdletBinding(SupportsShouldProcess=$true)&#93;Param()<br />function Test-Null($InputObject) { return !(&#91;bool&#93;$InputObject) }<br /><br />Function ResizeImage() {<br />param(&#91;String&#93;$ImagePath, &#91;Int&#93;$Quality = 90, &#91;Int&#93;$targetSize, &#91;String&#93;$OutputLocation)<br /><br />Add-Type -AssemblyName &quot;System.Drawing&quot;<br /><br />$img = &#91;System.Drawing.Image&#93;::FromFile($ImagePath)<br /><br />$CanvasWidth = $targetSize<br />$CanvasHeight = $targetSize<br /><br />#Encoder parameter for image quality<br />$ImageEncoder = &#91;System.Drawing.Imaging.Encoder&#93;::Quality<br />$encoderParams = New-Object System.Drawing.Imaging.EncoderParameters(1)<br />$encoderParams.Param&#91;0&#93; = New-Object System.Drawing.Imaging.EncoderParameter($ImageEncoder, $Quality)<br /><br /># get codec<br />$Codec = &#91;System.Drawing.Imaging.ImageCodecInfo&#93;::GetImageEncoders() | Where {$_.MimeType -eq 'image/jpeg'}<br /><br />#compute the final ratio to use<br />$ratioX = $CanvasWidth / $img.Width;<br />$ratioY = $CanvasHeight / $img.Height;<br /><br />$ratio = $ratioY<br />if ($ratioX -le $ratioY) {<br />$ratio = $ratioX<br />}<br /><br />$newWidth = &#91;int&#93; ($img.Width * $ratio)<br />$newHeight = &#91;int&#93; ($img.Height * $ratio)<br /><br />$bmpResized = New-Object System.Drawing.Bitmap($newWidth, $newHeight)<br />$graph = &#91;System.Drawing.Graphics&#93;::FromImage($bmpResized)<br />$graph.InterpolationMode = &#91;System.Drawing.Drawing2D.InterpolationMode&#93;::HighQualityBicubic<br /><br />$graph.Clear(&#91;System.Drawing.Color&#93;::White)<br />$graph.DrawImage($img, 0, 0, $newWidth, $newHeight)<br /><br />#save to file<br />$bmpResized.Save($OutputLocation, $Codec, $($encoderParams))<br />$bmpResized.Dispose()<br />$img.Dispose()<br />}<br /><br />#get sid and photo for current user<br />$user = (&#91;ADSISearcher&#93;&quot;(&amp;(objectCategory=User)(SAMAccountName=$env:username))&quot;).FindOne().Properties<br />$user_photo = $user.thumbnailphoto<br />$user_sid = &#91;System.Security.Principal.WindowsIdentity&#93;::GetCurrent().User.Value<br />Write-Verbose &quot;Updating account picture for $($user.displayname)...&quot;<br /><br />#continue if an image was returned<br />If ((Test-Null $user_photo) -eq $false) <br />{<br />Write-Verbose &quot;Success. Photo exists in Active Directory.&quot;<br /><br />#set up image sizes and base path<br />$image_sizes = @(32, 40, 48, 96, 192, 200, 240, 448)<br />$image_mask = &quot;Image{0}.jpg&quot;<br />$image_base = $env:public + &quot;\AccountPictures&quot;<br /><br />#set up registry<br />$reg_base = &quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\AccountPicture\Users\{0}&quot;<br />$reg_key = &#91;string&#93;::format($reg_base, $user_sid)<br />$reg_value_mask = &quot;Image{0}&quot;<br />If ((Test-Path -Path $reg_key) -eq $false) { New-Item -Path $reg_key } <br /><br />#save images, set reg keys<br />ForEach ($size in $image_sizes)<br />{<br />#create hidden directory, if it doesn't exist<br />$dir = $image_base + &quot;\&quot; + $user_sid<br />If ((Test-Path -Path $dir) -eq $false) { $(mkdir $dir).Attributes = &quot;Hidden&quot; }<br /><br />#save photo to disk, overwrite existing files<br />$file_name = (&#91;string&#93;::format($image_mask, $size))<br />$pathtmp = $dir + &quot;\_&quot; + $file_name<br />$path = $dir + &quot;\&quot; + $file_name<br />Write-Verbose &quot; saving: $file_name&quot;<br />$user_photo | Set-Content -Path $pathtmp -Encoding Byte -Force<br />ResizeImage $pathtmp $size $size $path<br />Remove-Item $pathtmp<br /><br />#save the path in registry, overwrite existing entries<br />$name = &#91;string&#93;::format($reg_value_mask, $size)<br />$value = New-ItemProperty -Path $reg_key -Name $name -Value $path -Force<br />}<br /><br />Write-Verbose &quot;Done.&quot;<br />} else { Write-Error &quot;No photo found in Active Directory for $env:username&quot; }</div><br /><br />The script basicly write a file for each resolution in C:\Users\Public\AccountPictures and creates the appropiate records in registry in HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\AccountPicture\Users<br /><br />With this method user's photo is correctly show at login and in all other places, except for in classicshell menu, it show the anonimusgray photo<br /><br />it's possibile to fix that?<br /><br />Thanks

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Gaurav</b> [ Thu Sep 21, 2017 4:25 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: User photo not loaded</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Try using Classic Start Menu's own &quot;User picture&quot; setting? It's on the General Behavior tab and its reg value is: HKCU\Software\IvoSoft\ClassicStartMenu\Settings. String value: UserPicturePath. A single high-res pic should work.<br /><br />If you change the Classic Start Menu Registry key, make sure to exit the Start Menu first and then start it again:<br />C:\Program Files\Classic Shell\ClassicStartMenu.exe -exit<br />C:\Program Files\Classic Shell\ClassicStartMenu.exe

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>skonvols2k</b> [ Thu Sep 21, 2017 6:16 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: User photo not loaded</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Gaurav wrote:</div><div class="quotecontent">Try using Classic Start Menu's own &quot;User picture&quot; setting? It's on the General Behavior tab and its reg value is: HKCU\Software\IvoSoft\ClassicStartMenu\Settings. String value: UserPicturePath. A single high-res pic should work.</div><br /><br />The strange think is that if you manually change user picture in windows settings, classic shell will automatically load it, but setting the user picture in windows via the provided script classicshell doesn't load that.<br />I will prefer that classicshell will load windows user picture automatically without setting the reg value you provide.<br />Thanks

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Ivo</b> [ Thu Sep 21, 2017 7:49 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: User photo not loaded</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Classic Shell simply asks Windows what bitmap to use.<br />You need to figure out what is the difference between manually setting the picture and running your script. Possibly you can run Process Monitor and see what is written where.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>skonvols2k</b> [ Thu Sep 21, 2017 11:50 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: User photo not loaded</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Ivo wrote:</div><div class="quotecontent">Classic Shell simply asks Windows what bitmap to use.<br />You need to figure out what is the difference between manually setting the picture and running your script. Possibly you can run Process Monitor and see what is written where.</div><br /><br />Hi,<br />i certainly do that, can you help me explaining how Classic Shell asks to windows what bitmap to use? Is a file? a Reg value?<br />i'm a sysadmin so don't worry and be specific <img src="images/smilies/icon_e_biggrin.gif" alt=":D" title="Very Happy" /> <br />Thanks

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Ivo</b> [ Fri Sep 22, 2017 8:17 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: User photo not loaded</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Classic Shell uses the undocumented interface IUserTileStore to get the path to the user image.

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>1</strong> of <strong>1</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 8 hours [ <abbr title="Daylight Saving Time">DST</abbr> ]</span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />https://www.phpbb.com/</span></td>
</tr>
</table>

</body>

<!-- Mirrored from www.classicshell.net/forum/viewtopic.php?f=12&t=7921&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 08 Jun 2018 09:12:15 GMT -->
</html>